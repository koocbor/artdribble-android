machine:
  environment:
    GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError"'
    java:
      version: oraclejdk8

dependencies:
  pre:
    # Get correct security policy to allow encryption testing
    # - sudo rsync -r --include=*/ --include=*.jar --exclude=* .jdk-overlay/jre $JAVA_HOME
    # Android SDK Platform 25 (Nougat 7.1.1)
    - if [ ! -d "/usr/local/android-sdk-linux/platforms/android-25" ]; then echo y | android update sdk --no-ui --all --filter "android-25"; fi
    # Android SDK Build-tools
    - if [ ! -d "/usr/local/android-sdk-linux/build-tools/25.0.3" ]; then echo y | android update sdk --no-ui --all --filter "build-tools-25.0.3"; fi
    # Google Repository / PlayServices
    - echo y | android update sdk --no-ui --all --filter "tools,extra-android-m2repository,extra-android-support,extra-google-google_play_services,extra-google-m2repository"
    - echo y | $ANDROID_HOME/tools/bin/sdkmanager "extras;m2repository;com;android;support;constraint;constraint-layout-solver;1.0.2"
    - echo y | $ANDROID_HOME/tools/bin/sdkmanager "extras;m2repository;com;android;support;constraint;constraint-layout;1.0.2"
    # Copy environment variables to securestrings.properties file for app build.gradle
    - ./.build-helpers/securestringsSetup.sh # && copyEnvVarsToSecureStringsProperties

  cache_directories:
    - /usr/local/android-sdk-linux/platforms/android-25
    - /usr/local/android-sdk-linux/build-tools/25.0.3
    - /usr/local/android-sdk-linux/extras/android/m2repository
    - /usr/local/android-sdk-linux/extras/google/m2repository

  override:
    # Adding true flag because of this issue with ConstraintLayout https://code.google.com/p/android/issues/detail?id=212128
    - ANDROID_HOME=/usr/local/android-sdk-linux ./gradlew dependencies || true

test:
  override:
    - ./.build-helpers/lint.sh
    - ./.build-helpers/coverage.sh
    - cp -r app/build/outputs $CIRCLE_ARTIFACTS
    - cp -r app/build/test-results/* $CIRCLE_TEST_REPORTS